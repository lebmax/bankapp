<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Банковское приложение</title>
    <script language="JavaScript">
        setInterval(() => {
            var td = document.getElementById('exchange_rates');
            fetch('http://localhost:8080/api/rates')
                .then(response => response.json())
                .then(json => {
                    var table = '<table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">';
                    table += '<tr><th colspan="3">Курсы валют по отношению к рублю</th></tr>';
                    table += '<tr><th>Валюта</th><th>Обозначение</th><th>Курс</th></tr>';
                    json.forEach(rate => {
                        table += '<tr>';
                        table += '<td>' + rate.title + '</td>';
                        table += '<td>' + rate.name + '</td>';
                        table += '<td>' + rate.value + '</td>';
                        table += '</tr>';
                    });
                    table += '</table>';
                    td.innerHTML = table;
                })
                .catch(error => td.innerHTML = 'Ошибка при получении данных курсов валют');
        }, 1000);
    </script>
</head>

<body>
<a href="/signup" style="float:right;">
    <b>РЕГИСТРАЦИЯ &plus;</b>
</a>
<br>
<a href="/logout" style="float:right;">
    <b>ВЫЙТИ &cudarrr;</b>
</a>
<table style="width:70%;margin-left:auto;margin-right:auto;">
    <tr>
        <td style="padding:2px;">
            <form method="post" th:action="@{/user/{login}/delete-user(login=${user.login})}" th:object="${user}">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                    <tr>
                        <td style="font-weight:bold;">Логин</td>
                        <td colspan="2" th:text="${user.login}"/>
                        <td>
                            <form th:action="@{/user/{login}/delete-user(login=${user.login})}" method="post"
                                  style="display:inline;">
                                <input type="hidden" name="_method" value="delete"/>
                                <button type="submit">Удалить пользователя</button>
                            </form>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <tr>
        <td style="padding:2px;">
            <form method="post" th:action="@{/user/{login}/edit-password(login=${user.login})}" th:object="${user}">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                    <tr>
                        <td style="font-weight:bold;">Изменить пароль</td>
                        <td>
                            <!--                    <p style="color:red;" th:if="${passwordErrors!=null}" th:each="passwordError : ${passwordErrors}" th:text="${passwordError}"/>-->
                            <p>
                                Пароль: <input id="password" name="password" minlength="1" maxlength="20" type="text"
                                               th:value="${password}" style="width:100%" required/>
                            </p>
                            <p>
                                Повторите пароль: <input id="confirmedPassword" name="confirmedPassword" minlength="1"
                                                         maxlength="20" type="text" th:value="${confirmedPassword}"
                                                         style="width:100%" oninput=checkIfPasswordConfirmed()
                                                         required/>
                            </p>
                            <input type="hidden" th:field="*{id}" id="id">
                            <input type="hidden" th:field="*{login}" id="login">
                            <input type="hidden" th:field="*{name}" id="name">
                            <input type="hidden" th:field="*{surname}" id="surname">
                            <input type="hidden" th:field="*{birthdate}" id="birthdate">
                            <input type="hidden" th:field="*{role}" id="role">
                        </td>
                        <td style="text-align:right">
                            <button>Изменить пароль</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <tr>
        <td style="padding:2px;">
            <form method="post" th:action="@{/user/{login}/edit-other-data(login=${user.login})}" th:object="${user}">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                    <tr>
                        <td style="font-weight:bold;">Изменить имя, фамилию, дату рождения</td>
                        <td>
                            <p>
                                Имя: <input id="name2" name="name" minlength="1" maxlength="20" type="text"
                                            th:value="${name}" style="width:100%" required/>
                            </p>
                            <p>
                                Фамилия: <input id="surname2" name="surname" minlength="1"
                                                maxlength="20" type="text" th:value="${surname}"
                                                style="width:100%" required/>
                            </p>
                            <p>
                                Дата рождения: <input id="birthdate2" name="birthdate" type="date"
                                                      th:value="${birthdate}" style="width:100%"
                                                      oninput=checkIfNotAdult() required/>

                            </p>
                            <input type="hidden" th:field="*{id}">
                            <input type="hidden" th:field="*{login}">
                            <input type="hidden" th:field="*{password}">
                            <input type="hidden" th:field="*{role}">
                        </td>
                        <td style="text-align:right">
                            <button>Изменить имя, фамилию, дату рождения</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <!--<tr>
        <td style="padding:2px;">
            <form method="post" th:action="${'/user/'+login+'/editUserData'}">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
&lt;!&ndash;                    <tr th:if="${userAccountsErrors!=null}" th:each="userAccountsError : ${userAccountsErrors}">
                        <td style="color:red;" th:text="${userAccountsError}"/>
                    </tr>&ndash;&gt;
                    <tr>
                        <td style="font-weight:bold;">Имя (длина - от 2 до 20 символов)</td>
                        <td>
                            <input name="name" minlength="1" maxlength="20" type="text" th:value="${name}"
                                   style="width:100%" required/>
                        </td>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Фамилия (длина - от 2 до 20 символов)</td>
                        <td>
                            <input name="surname" minlength="1" maxlength="20" type="text" th:value="${surname}"
                                   style="width:100%" required/>
                        </td>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Дата рождения</td>
                        <td>
                            <input id="birthdate2" name="birthdate" type="date" th:value="${birthdate}"
                                   style="width:100%" oninput=checkIfNotAdult() required/>

                        </td>
                    </tr>
                    <tr th:each="account : ${accounts}">
                        <td style="font-weight:bold;" th:text="${account.getCurrency().getTitle()}"/>
                        <td th:text="${account.isExists() ? (account.getValue()+' '+account.getCurrency().name()) : ''}"/>
                        <td style="text-align:right">
                            <input name="account" type="checkbox" th:checked="${account.isExists()}"
                                   th:value="${account.getCurrency().name()}"/>
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:right" colspan="3">
                            <button>Сохранить изменения</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>-->
    <tr>
        <td style="padding:2px;">
            <form method="post" th:action="${'/user/'+login+'/сash'}">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                    <tr th:if="${cashErrors!=null}" th:each="cashError : ${cashErrors}">
                        <td style="color:red;" th:text="${cashError}"/>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Наличные</td>
                        <td>
                            Валюта
                            <select name="currency">
                                <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.name()}"
                                        th:text="${eachCurrency.getTitle()}"/>
                            </select>
                        </td>
                        <td>
                            <input name="value" type="number" style="width:100%" required/>
                        </td>
                        <td>
                        <td style="text-align:right">
                            <button name="action" value="PUT">Положить</button>
                            <button name="action" value="GET">Снять</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <tr>
        <td style="padding:2px;">
            <form method="post" th:action="${'/user/'+login+'/transfer'}">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                    <tr th:if="${transferErrors!=null}" th:each="transferError : ${transferErrors}">
                        <td style="color:red;" th:text="${transferError}"/>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Перевод себе</td>
                        <td>
                            Со счета
                            <select name="from_currency">
                                <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.name()}"
                                        th:text="${eachCurrency.getTitle()}"/>
                            </select>
                        </td>
                        <td>
                            На счет
                            <select name="to_currency">
                                <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.name()}"
                                        th:text="${eachCurrency.getTitle()}"/>
                            </select>
                        </td>
                        <td>
                            <input name="value" type="number" style="width:100%" required/>
                        </td>
                        <td style="text-align:right">
                            <input hidden name="to_login" th:value="${login}"/>
                            <button>Перевести</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <tr>
        <td style="padding:2px;">
            <form method="post" th:action="${'/user/'+login+'/transfer'}">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                    <tr th:if="${transferOtherErrors!=null}" th:each="transferOtherError : ${transferOtherErrors}">
                        <td style="color:red;" th:text="${transferOtherError}"/>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Перевод другому</td>
                        <td>
                            Со счета
                            <select name="from_currency">
                                <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.name()}"
                                        th:text="${eachCurrency.getTitle()}"/>
                            </select>
                        </td>
                        <td>
                            На счет
                            <select name="to_currency">
                                <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.name()}"
                                        th:text="${eachCurrency.getTitle()}"/>
                            </select>
                        </td>
                        <td>
                            <input name="value" type="number" required/>
                        </td>
                        <td>
                            Кому
                            <select name="to_login">
                                <option th:each="user : ${users}" th:value="${user.getLogin()}"
                                        th:text="${user.getName()}"/>
                            </select>
                        </td>
                        <td style="text-align:right">
                            <button>Перевести</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <tr>
        <td style="padding:2px;" id="exchange_rates">
        </td>
    </tr>
</table>

<script>
    function checkIfPasswordConfirmed() {
        var password = document.getElementById("password").value;
        var confirmedPassword = document.getElementById("confirmedPassword").value;
        if (password !== confirmedPassword) {
            alert("Пароли не совпадают. Введите повторно корректный пароль. В противном случае, пользователь не будет сохранен");
        }
    }
    function checkIfNotAdult() {
        var birthdate = Date.parse(document.getElementById("birthdate2").value);
        var currentDate = Date.now();
        var delta = parseInt((currentDate - birthdate) / (1000 * 60 * 60 * 24 * 365));
        if (delta < 18) {
        alert("Пользователь не достиг 18 лет. Заводить банковский аккаунт ему запрещено");
        }
    }
</script>
</body>

</html>